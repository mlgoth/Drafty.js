var Drafty=function(a,c,b){this.backend_url="backdraft.ajax.php";this.draft_ident=a;this.html_id=c;this.last_restored="";this.msg_id=b?b:null;this.umsgs={no_text:"No text have been input - nothing to save",no_chg1:"Draft not saved - there are no changes",no_chg2:"Draft not saved - no changes since last restore",ajax_err:"Drafty AJAX problem"};$("#drafty-box").css("visibility","visible");this.setup_devmode(false);this.dmsg("Drafty object created")};Drafty.prototype.setup_devmode=function(a){this.DEV_MODE=a;if(this.DEV_MODE){if(document.getElementById("drafty-logpane")){this.log_pane="#drafty-logpane"}if(this.log_pane){$(this.log_pane).css("display","block");$(this.log_pane).css("visibility","visible")}}else{if(this.log_pane){$(this.log_pane).html("Devmode disabled")}this.log_pane=null}};Drafty.prototype.ajax_url=function(b){var a=this.backend_url;if(this.DEV_MODE&&b){a+="?"+b}return a};Drafty.prototype.dmsg=function(a){if(!this.DEV_MODE||!this.log_pane){return}var b=this.log_pane;a=new Date().toTimeString().substr(0,8)+" "+a+" ("+this.html_id+")";$(b).html(a+"<br>"+$(b).html())};Drafty.prototype.errormsg=function(a){this.dmsg(a);if(!this.msg_id){return}this.usermsg(this.umsgs.ajax_err+": "+a)};Drafty.prototype.usermsg=function(a){if(a){this.dmsg("uMsg: "+a)}if(!this.msg_id){return}if(a){$("#"+this.msg_id).html('<span class="drafty-msg">&nbsp;'+a+"&nbsp;</div>")}else{$("#"+this.msg_id).html("")}};Drafty.prototype.save_draft=function(b){this.usermsg();var d=$("#"+this.html_id).val();if(""==d.trim()){if(!b){this.usermsg(this.umsgs.no_text)}return}if(this.last_saved==d){if(!b){this.usermsg(this.umsgs.no_chg1)}return}if((this.last_restored!="")&&(d==this.last_restored)){if(!b){this.usermsg(this.umsgs.no_chg2)}return}if(this.saving_cb){this.saving_cb(1)}this.dmsg("Saving draft");var a={op:"save",data:d,ident:this.draft_ident};var c=this;if(c.saving_cb){c.saving_cb(2)}$.post(this.ajax_url("save"),a,function(f,e){if(c.saving_cb){c.saving_cb(3)}if(e!="success"){c.errormsg("save_draft() ajax failure "+e);return}if(!f||!f.msg){c.errormsg("JSON unparseable");return}c.last_saved=d;if(f.msg){c.usermsg("ajax msg: "+f.msg)}c.refresh_genlist();if(c.saving_cb){c.saving_cb(0)}c.dmsg("Draft #"+f.gen+" saved")},"json")};Drafty.prototype.restore_draft=function(b){var a={op:"load",genno:b,ident:this.draft_ident};var c=this;$.post(this.ajax_url("restore"),a,function(e,d){$("#"+c.html_id).val(e.data);c.last_restored=e.data;c.dmsg("ajax:"+e.msg);c.dmsg("Draft #"+b+" restored ")},"json")};Drafty.prototype.refresh_genlist=function(b){this.dmsg("Pulling new genlist");var a=this;if(0){$.post(this.ajax_url("genlist"),{op:"genlist",ident:this.draft_ident},function(d,c){if(c!="success"){a.errormsg("AJAX failed "+c);return}if(d.msg){a.dmsg("ajax:"+d.msg)}$("#drafty-genlist").html(d.html);a.dmsg("Genlist refreshed, have "+d.cnt+" draft generations");if(b&&d.cnt>0){b(d.max)}},"json")}else{$.post(this.ajax_url("genlist"),{op:"genlist",ident:this.draft_ident},function(d,c){if(c!="success"){a.errormsg("AJAX-1 failed "+c);return}if(!d||d===""){a.errormsg("AJAX-2 failed "+c);return}var g;try{g=jQuery.parseJSON(d)}catch(f){a.errormsg("AJAX failed(3) - error parsing JSON");return}if(g.msg){a.dmsg("ajax:"+g.msg)}$("#drafty-genlist").html(g.html);a.dmsg("Genlist refreshed, have "+g.cnt+" draft generations");if(b&&g.cnt>0){b(g.max)}},"text")}};Drafty.prototype.kill_all=function(){this.dmsg("Wipe all draft gens");args={op:"wipe",ident:this.draft_ident};var a=this;$.post(this.ajax_url("killall"),args,function(c,b){if(b!="success"){console.error("ajax failed "+b);return}a.last_saved=a.last_restored=null;if("msg" in c){a.errormsg("AJAX error:"+c.msg)}else{a.dmsg("All "+c.cnt+" draft generations removed")}a.refresh_genlist()},"json")};Drafty.prototype.autosave_init=function(){if(this.timer){window.clearInterval(this.timer);this.timer=null;this.dmsg("Autosave timer stopped")}if(this.autosave_secs>0){this.dmsg("Autosaving every "+this.autosave_secs+" seconds");var a=this;this.timer=window.setInterval(function(){a.save_draft(true)},this.autosave_secs*1000)}else{this.dmsg("Autosaving disabled")}};Drafty.prototype.autosave_setup=function(a){this.autosave_secs=a;this.autosave_init()};Drafty.prototype.toggle_devmode=function(){this.setup_devmode(!this.DEV_MODE);this.usermsg("Devmode is now "+(this.DEV_MODE?"enabled":"disabled"))};function autosave_input(f,d){function b(g){if(!g){g=this}if(g.input_area.value==g.last_saved){return}g.save_draft()}function c(){if(this.timer){window.clearInterval(this.timer);this.timer=null}}function e(){this.clear_timer();var g=this;this.timer=window.setInterval(function(){b(g)},8*1000)}function a(g){g.dmsg("FOCUS!");g.setup_timer();g.input_area.onblur=function(){window.clearInterval(g.timer);g.testForChange(g);g.input_area.onblur=null}}xxthat=this;this.input_area.onfocus=function(){a(xxthat)}};