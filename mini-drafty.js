var Drafty=function(a,d,c,b){this.DEV_MODE=true;this.draft_ident=a;this.html_id=d;this.last_restored="";this.msg_id=c?c:null;this.log_pane=b?b:null;$("#drafty-box").css("visibility","visible");if(this.DEV_MODE&&this.log_pane){$("#"+this.log_pane).css("visibility","visible")}this.dmsg("Drafty object created")};Drafty.prototype.ajax_url=function(b){var a="ajax/backdraft-gc.ajax.php";if(this.DEV_MODE&&b){a+="?"+b}return a};Drafty.prototype.dmsg=function(a){if(!this.DEV_MODE||!this.log_pane){return}var b="#"+this.log_pane;a=new Date().toTimeString().substr(0,8)+" "+a+" ("+this.html_id+")";$(b).html(a+"<br>"+$(b).html())};Drafty.prototype.errormsg=function(a){this.dmsg(a);if(!this.msg_id){return}this.usermsg("Draft problem: "+a)};Drafty.prototype.usermsg=function(a){if(a){this.dmsg("uMsg: "+a)}if(!this.msg_id){return}if(a){$("#"+this.msg_id).html('<span class="drafty-msg">&nbsp;'+a+"&nbsp;</div>")}else{$("#"+this.msg_id).html("")}};Drafty.prototype.save_draft=function(c){this.usermsg();var a=document.getElementById("drafty-asave-indicator")?true:false;if(a){$("#drafty-asave-indicator").html("|")}var e=$("#"+this.html_id).val();if(""==e.trim()){if(!c){this.usermsg("Du har jo ikke skrevet noget")}return}if(this.last_saved==e){if(!c){this.usermsg("Kladde ikke gemt - der er ingen ændringer")}return}if((this.last_restored!="")&&(e==this.last_restored)){if(!c){this.usermsg("Ikke gemt - ingen ændringer siden gendannelse")}return}document.body.style.cursor="progress";if(a){$("#drafty-asave-indicator").html("/")}this.dmsg("Saving draft");var b={op:"save",data:e,ident:this.draft_ident};var d=this;$.post(this.ajax_url("save"),b,function(g,f){if(a){$("#drafty-asave-indicator").html("-")}if(f!="success"){d.errormsg("save_draft() ajax failure "+f);return}if(!g||!g.msg){d.errormsg("JSON unparseable");return}d.last_saved=e;d.dmsg("ajax:"+g.msg);d.dmsg("Draft #"+g.gen+" saved ");if(a){$("#drafty-asave-indicator").html("\\")}d.refresh_genlist();if(a){$("#drafty-asave-indicator").html("")}document.body.style.cursor="default"},"json")};Drafty.prototype.restore_draft=function(b){var a={op:"load",genno:b,ident:this.draft_ident};var c=this;$.post(this.ajax_url("restore"),a,function(e,d){$("#"+c.html_id).val(e.data);c.last_restored=e.data;c.dmsg("ajax:"+e.msg);c.dmsg("Draft #"+b+" restored ")},"json")};Drafty.prototype.refresh_genlist=function(b){this.dmsg("Pulling new genlist");var a=this;$.post(this.ajax_url("genlist"),{op:"genlist",ident:this.draft_ident},function(d,c){if(c!="success"){a.errormsg("AJAX failed "+c);return}if(d.msg){a.dmsg("ajax:"+d.msg)}$("#drafty-genlist").html(d.html);a.dmsg("Genlist refreshed, have "+d.cnt+" draft generations");if(b&&d.cnt>0){b(d.max)}},"json")};Drafty.prototype.kill_all=function(){this.dmsg("Wipe all draft gens");args={op:"wipe",ident:this.draft_ident};var a=this;$.post(this.ajax_url("killall"),args,function(c,b){if(b!="success"){console.error("ajax failed "+b);return}a.last_saved=a.last_restored=null;if("msg" in c){a.errormsg("AJAX error:"+c.msg)}else{a.dmsg("All "+c.cnt+" draft generations removed")}a.refresh_genlist()},"json")};Drafty.prototype.autosave_init=function(){if(this.timer){window.clearInterval(this.timer);this.timer=null;this.dmsg("Autosave timer stopped")}if(this.autosave_secs>0){this.dmsg("Autosaving every "+this.autosave_secs+" seconds");var a=this;this.timer=window.setInterval(function(){a.save_draft(true)},this.autosave_secs*1000)}else{this.dmsg("Autosaving disabled")}};Drafty.prototype.autosave_setup=function(a){this.autosave_secs=a;this.autosave_init()};function autosave_input(f,d){function b(g){if(!g){g=this}if(g.input_area.value==g.last_saved){return}g.save_draft()}function c(){if(this.timer){window.clearInterval(this.timer);this.timer=null}}function e(){this.clear_timer();var g=this;this.timer=window.setInterval(function(){b(g)},8*1000)}function a(g){g.dmsg("FOCUS!");g.setup_timer();g.input_area.onblur=function(){window.clearInterval(g.timer);g.testForChange(g);g.input_area.onblur=null}}xxthat=this;this.input_area.onfocus=function(){a(xxthat)}};